name: Android Build AAB (v7.7 Self-Sustaining)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      NODE_ENV: production
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx2048m

    steps:
      # 1Ô∏è‚É£ Repozitorij i meta-informacije
      - name: üß© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß† Log build context
        run: |
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Branch: $GITHUB_REF_NAME"
          echo "Commit: $GITHUB_SHA"
          echo "Actor: $GITHUB_ACTOR"

      # 2Ô∏è‚É£ Okru≈æenje (Java + Node)
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ‚öôÔ∏è Setup Node.js 20 (Auto-cache if lockfile)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      # 3Ô∏è‚É£ Instalacija ovisnosti s fallbackom
      - name: üì¶ Install npm dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "‚úÖ Using npm ci"
            npm ci
          else
            echo "‚ö†Ô∏è No lockfile ‚Üí using npm install"
            npm install
          fi

      # 4Ô∏è‚É£ Gradle validacija
      - name: üîç Validate Gradle Wrapper
        run: chmod +x android/gradlew

      # 5Ô∏è‚É£ Build
      - name: üèóÔ∏è Build Android App Bundle (.aab)
        working-directory: android
        run: ./gradlew clean bundleRelease --stacktrace

      # 6Ô∏è‚É£ Samoprovjera build artefakta
      - name: üî¨ Self-check build output
        id: check
        run: |
          FILE=$(find android/app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          if [ -f "$FILE" ]; then
            SIZE=$(du -h "$FILE" | cut -f1)
            echo "‚úÖ Found AAB: $FILE ($SIZE)"
            echo "AAB_FILE=$FILE" >> $GITHUB_ENV
          else
            echo "‚ùå No .aab file found!"
            exit 1
          fi

      # 7Ô∏è‚É£ Upload rezultata
      - name: ‚òÅÔ∏è Upload AAB artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: ${{ env.AAB_FILE }}

      # 8Ô∏è‚É£ Auto-notification / self-report
      - name: üì° Self-report summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "‚úÖ Build OK ‚Äî Self-check passed."
          else
            echo "‚ùå Build failed ‚Äî please check logs."
          fi

      # 9Ô∏è‚É£ Auto-recovery: ponovni poku≈°aj ako je problem mre≈æa/cache
      - name: üîÅ Auto-retry (1x)
        if: failure()
        run: |
          echo "‚ö†Ô∏è Retry triggered..."
          sleep 5
          ./android/gradlew bundleRelease || echo "Retry failed, manual check needed"
