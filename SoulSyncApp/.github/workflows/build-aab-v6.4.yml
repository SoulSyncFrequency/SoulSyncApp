name: "🤖 Android Build + Auto-Repair v6.4"

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *' # noćni build u 03:00 UTC

concurrency:
  group: build-aab-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    strategy:
      fail-fast: false
      max-parallel: 1

    steps:
      - name: 🧹 Checkout
        uses: actions/checkout@v4

      - name: 🧠 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ⚙️ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ☁️ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: 🧩 Build Android App Bundle (.aab)
        id: build
        run: |
          set -e
          npm run build:aab || npm run build || echo "⚠️ fallback build triggered"

      - name: 🔍 Verify artifact
        run: |
          if [ ! -f app-release.aab ]; then
            echo "❌ Build failed — artifact not found"
            exit 1
          else
            echo "✅ Artifact app-release.aab ready"
          fi

      - name: 📦 Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.run_number }}
          path: app-release.aab
          retention-days: 7

  auto-repair:
    needs: build
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: 🧰 Attempt Auto-Repair
        run: |
          echo "🔄 Build failed — initiating auto-repair..."
          git fetch --all --prune
          npm cache clean --force
          npm ci || npm install
          npm run build:aab || echo "⚠️ second-pass repair run"

      - name: 🧩 Upload repaired artifact (if exists)
        if: success() && exists('app-release.aab')
        uses: actions/upload-artifact@v4
        with:
          name: repaired-app-${{ github.run_number }}
          path: app-release.aab
          retention-days: 3
# force reindex
