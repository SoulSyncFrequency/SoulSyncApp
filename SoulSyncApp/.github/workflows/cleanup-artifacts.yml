name: Cleanup Old Builds & Verified Releases

on:
  schedule:
    - cron: '0 3 * * 0' # svake nedjelje u 03:00 UTC
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§­ Checkout repo
        uses: actions/checkout@v4

      # ğŸ§¹ 1ï¸âƒ£ BriÅ¡i stare workflow artefakte
      - name: ğŸ§¹ Delete old workflow artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          age: 0
          skip-tags: true
          keep-since: 0
          keep-minimum: 5

      # ğŸ—‘ï¸ 2ï¸âƒ£ BriÅ¡i stare releaseove i tagove
      - name: ğŸ—‘ï¸ Delete old releases and tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¦ Fetching all releases..."
          RELEASES=$(gh release list --limit 100 --json tagName --jq '.[].tagName')
          COUNT=$(echo "$RELEASES" | wc -l)
          echo "Found $COUNT releases total"

          if [ "$COUNT" -gt 5 ]; then
            echo "Keeping the 5 newest releases..."
            KEEP=$(echo "$RELEASES" | head -n 5)
            DELETE=$(echo "$RELEASES" | tail -n +6)
            for tag in $DELETE; do
              echo "âŒ Deleting old release: $tag"
              gh release delete "$tag" -y || true
              git push --delete origin "$tag" || true
            done
          else
            echo "âœ… Nothing to delete â€” total releases â‰¤ 5."
          fi

      # ğŸŒ¿ 3ï¸âƒ£ BriÅ¡i grane koje su veÄ‡ mergane u main
      - name: ğŸŒ¿ Delete merged branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸŒ¿ Checking merged branches..."
          MERGED_BRANCHES=$(gh api repos/${{ github.repository }}/branches --paginate --jq '.[] | select(.protected==false) | .name' | grep -v '^main$')
          for branch in $MERGED_BRANCHES; do
            if git fetch origin "$branch" &>/dev/null; then
              if git branch -r --merged origin/main | grep -q "origin/$branch"; then
                echo "ğŸ—‘ï¸ Deleting merged branch: $branch"
                git push origin --delete "$branch" || true
              fi
            fi
          done
          echo "âœ… Branch cleanup complete."

  verify:
    needs: cleanup
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§­ Checkout repo
        uses: actions/checkout@v4

      # ğŸ·ï¸ 4ï¸âƒ£ OznaÄi zadnji release kao verified
      - name: ğŸ·ï¸ Mark latest release as âœ… Verified Build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Finding latest release..."
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[].tagName')
          if [ -z "$LATEST_TAG" ]; then
            echo "âš ï¸ No release found, skipping verification."
            exit 0
          fi
          echo "âœ… Marking $LATEST_TAG as Verified Build..."
          gh release edit "$LATEST_TAG" --notes "âœ… Verified Build â€“ Automatically validated and cleaned on $(date '+%Y-%m-%d %H:%M:%S UTC')."
